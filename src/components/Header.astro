---
// src/components/Header.astro
import Container from "./ui/Container.astro"; // <--- 1. IMPORTA QUESTO

const navLinks = [
    { href: "/", label: "Home" },
    { href: "/chi-siamo", label: "Chi siamo" },
    { href: "/eventi", label: "Eventi" },
    { href: "/sponsor", label: "Sponsor" },
    { href: "/foto-e-video", label: "Foto e video" },
    { href: "/documenti", label: "Documenti" },
    { href: "/contatti", label: "Contatti" },
];

const currentPath = Astro.url.pathname;
---

<header
    class="bg-background-secondary shadow-sm border-b border-gray-100 sticky top-0 z-50"
>
    <Container class="py-4">
        <div class="flex items-center justify-between">
            <a
                class="flex-shrink-0 transition-transform duration-300 hover:scale-105"
                href="/"
            >
                <img
                    src="/assets/canta-rei-logo.png"
                    alt="Coro Polifonico Canta Rei"
                    class="h-16 object-contain"
                />
            </a>

            <nav id="desktop-menu" class="hidden lg:flex space-x-8">
                {
                    navLinks.map((link) => (
                        <a
                            class:list={[
                                "nav-link text-lg font-medium transition-colors duration-200",
                                currentPath === link.href ||
                                (link.href !== "/" &&
                                    currentPath.startsWith(link.href))
                                    ? "text-accent-primary font-semibold"
                                    : "text-text-primary hover:text-accent-primary",
                            ]}
                            href={link.href}
                        >
                            {link.label}
                        </a>
                    ))
                }
            </nav>

            <div class="lg:hidden">
                <button
                    id="mobile-menu-button"
                    class="p-2 text-text-primary hover:text-accent-primary transition-colors"
                    aria-label="Toggle menu"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="lucide lucide-menu"
                    >
                        <line x1="4" x2="20" y1="12" y2="12"></line>
                        <line x1="4" x2="20" y1="6" y2="6"></line>
                        <line x1="4" x2="20" y1="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
    </Container>
    <div
        id="mobile-menu"
        class="fixed inset-0 z-50 bg-background-primary hidden flex-col"
    >
        <div
            class="flex justify-between items-center p-4 border-b border-gray-200"
        >
            <a href="/">
                <img
                    src="/assets/canta-rei-logo.png"
                    alt="Coro Polifonico Canta Rei"
                    class="h-12 object-contain"
                />
            </a>
            <button
                id="mobile-menu-close-button"
                class="p-2 text-text-primary hover:text-accent-primary transition-colors"
                aria-label="Close menu"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="lucide lucide-x"
                >
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
        </div>
        <nav
            class="flex-grow overflow-y-auto flex flex-col items-center justify-center space-y-6 p-6"
        >
            {
                navLinks.map((link) => (
                    <a
                        href={link.href}
                        class="text-3xl font-medium text-text-primary hover:text-accent-primary transition-colors mobile-link"
                    >
                        {link.label}
                    </a>
                ))
            }
        </nav>
    </div>
</header>

<script>
    function initMobileMenu() {
        // Aggiungiamo 'as HTMLElement' per essere sicuri dei tipi
        const menuBtn = document.getElementById(
            "mobile-menu-button",
        ) as HTMLElement | null;
        const closeBtn = document.getElementById(
            "mobile-menu-close-button",
        ) as HTMLElement | null;
        const menu = document.getElementById("mobile-menu");
        const links = document.querySelectorAll(".mobile-link");

        const toggleMenu = () => {
            menu?.classList.toggle("hidden");
            menu?.classList.toggle("flex");
            document.body.classList.toggle("overflow-hidden");
        };

        // FIX TYPESCRIPT:
        // 1. Definiamo che 'element' può essere HTMLElement o null
        // 2. Usiamo 'as HTMLElement' dopo il cloneNode perché di base restituisce un 'Node' generico
        const cleanListener = (element: HTMLElement | null) => {
            if (!element) return null;
            const newElement = element.cloneNode(true) as HTMLElement;
            element.parentNode?.replaceChild(newElement, element);
            return newElement;
        };

        // Puliamo e riassegnamo
        const cleanMenuBtn = cleanListener(menuBtn);
        const cleanCloseBtn = cleanListener(closeBtn);

        cleanMenuBtn?.addEventListener("click", toggleMenu);
        cleanCloseBtn?.addEventListener("click", toggleMenu);

        links.forEach((link) => {
            link.addEventListener("click", toggleMenu);
        });
    }

    document.addEventListener("astro:page-load", initMobileMenu);
</script>

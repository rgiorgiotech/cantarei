---
// src/pages/eventi/index.astro
import Layout from "../../layouts/Layout.astro";
import Container from "../../components/ui/Container.astro";
import Button from "../../components/ui/Button.astro";
import { getCollection } from "astro:content";

// 1. Recupera e ordina gli eventi
const allEvents = await getCollection("events");
const sortedEvents = allEvents.sort(
    (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

// 2. Dividi tra Futuri e Passati
const now = new Date();
// Impostiamo l'orario a 00:00 per confrontare solo i giorni
now.setHours(0, 0, 0, 0);

const upcomingEvents = sortedEvents
    .filter((event) => event.data.date >= now)
    .reverse(); // I futuri li voglio dal più vicino al più lontano
const pastEvents = sortedEvents.filter((event) => event.data.date < now);

const formatDate = (date: Date) => {
    return new Intl.DateTimeFormat("it-IT", {
        day: "numeric",
        month: "long",
        year: "numeric",
    }).format(date);
};
---

<Layout title="Eventi">
    <section class="py-20 bg-background-primary min-h-screen">
        <Container>
            <div class="text-center mb-16 animate-fade-in">
                <h1 class="text-5xl font-bold text-accent-primary mb-4">
                    Eventi
                </h1>
                <p class="text-xl text-gray-600">
                    La nostra storia attraverso i concerti
                </p>
            </div>

            {
                upcomingEvents.length > 0 && (
                    <div class="mb-20">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="p-2 bg-accent-primary rounded-full text-white">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="24"
                                    height="24"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <>
                                        <path d="M8 2v4" />
                                        <path d="M16 2v4" />
                                        <rect
                                            width="18"
                                            height="18"
                                            x="3"
                                            y="4"
                                            rx="2"
                                        />
                                        <path d="M3 10h18" />
                                    </>
                                </svg>
                            </div>
                            <h2 class="text-3xl font-bold">
                                Prossimi Appuntamenti
                            </h2>
                        </div>

                        <div class="grid gap-8">
                            {upcomingEvents.map((event) => (
                                <div class="bg-white rounded-xl p-8 shadow-lg border-l-8 border-accent-primary flex flex-col md:flex-row justify-between items-center gap-6">
                                    <div>
                                        <span class="text-accent-primary font-bold tracking-widest uppercase text-sm mb-2 block">
                                            In Programma
                                        </span>
                                        <h3 class="text-3xl font-bold mb-2">
                                            {event.data.title}
                                        </h3>
                                        <p class="text-xl text-gray-700 flex items-center gap-2">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                width="18"
                                                height="18"
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                            >
                                                <rect
                                                    width="18"
                                                    height="18"
                                                    x="3"
                                                    y="4"
                                                    rx="2"
                                                />
                                                <path d="M16 2v4" />
                                                <path d="M8 2v4" />
                                                <path d="M3 10h18" />
                                            </svg>
                                            {formatDate(event.data.date)}
                                        </p>
                                        {event.data.location && (
                                            <p class="text-gray-500 mt-1">
                                                {event.data.location}
                                            </p>
                                        )}
                                    </div>
                                    <Button
                                        href={`/eventi/${event.slug}`}
                                        variant="primary"
                                    >
                                        Info e Biglietti
                                    </Button>
                                </div>
                            ))}
                        </div>
                    </div>
                )
            }

            <div>
                <h2
                    class="text-3xl font-bold mb-8 border-b border-gray-200 pb-4"
                >
                    Archivio Eventi
                </h2>

                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {
                        pastEvents.map((event) => (
                            <a
                                href={`/eventi/${event.slug}`}
                                class="group block h-full"
                            >
                                <article
                                    class:list={[
                                        "h-full flex flex-col rounded-xl overflow-hidden bg-white shadow-sm hover:shadow-xl transition-all duration-300 hover:-translate-y-1 border border-gray-100",
                                        event.data.isArsEvent &&
                                            "ring-1 ring-accent-primary/30",
                                    ]}
                                >
                                    {/* Se c'è il poster usiamo quello come "copertina", altrimenti un gradiente */}
                                    <div class="h-48 overflow-hidden bg-gray-100 relative">
                                        {event.data.poster ? (
                                            <img
                                                src={event.data.poster}
                                                alt={event.data.title}
                                                class="w-full h-full object-cover object-top opacity-90 group-hover:opacity-100 transition-opacity"
                                            />
                                        ) : (
                                            <div class="w-full h-full bg-gradient-to-br from-background-secondary to-gray-200 flex items-center justify-center text-accent-primary/20">
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    width="64"
                                                    height="64"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                >
                                                    <path d="M9 18V5l12-2v13" />
                                                    <circle
                                                        cx="6"
                                                        cy="18"
                                                        r="3"
                                                    />
                                                    <circle
                                                        cx="18"
                                                        cy="16"
                                                        r="3"
                                                    />
                                                </svg>
                                            </div>
                                        )}

                                        {event.data.isArsEvent && (
                                            <div class="absolute top-2 right-2 bg-accent-primary text-white text-xs font-bold px-2 py-1 rounded">
                                                ARS CORI
                                            </div>
                                        )}
                                    </div>

                                    <div class="p-6 flex-grow flex flex-col">
                                        <p class="text-sm text-accent-primary font-medium mb-2">
                                            {formatDate(event.data.date)}
                                        </p>
                                        <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-accent-primary transition-colors">
                                            {event.data.title}
                                        </h3>
                                        <p class="text-gray-600 line-clamp-3 text-sm">
                                            {event.body}
                                        </p>

                                        <div class="mt-auto pt-4 text-sm font-semibold text-accent-primary flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity transform translate-x-[-10px] group-hover:translate-x-0">
                                            Leggi tutto &rarr;
                                        </div>
                                    </div>
                                </article>
                            </a>
                        ))
                    }
                </div>
            </div>
        </Container>
    </section>
</Layout>
